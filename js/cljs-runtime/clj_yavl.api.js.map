{"version":3,"sources":["clj_yavl/api.cljc"],"mappings":"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","names":["clj-yavl.api/google-colors","clj-yavl.api/default-config","clj-yavl.api/infer-vl-type","schema-node","t","malli.core.type","fexpr__25276","fexpr__25277","fexpr__25278","fexpr__25279","cljs.core._EQ_","clj-yavl.api/get-field-schema","dataset-schema","field-name","schema","malli.core.schema","map-schema","fexpr__25281","cljs.core/first","malli.core.children","cljs.core/some","p__25282","vec__25283","cljs.core.nth","k","_","v","cljs.core/name","clj-yavl.api/get-field-props","fexpr__25290","p__25291","vec__25292","props","clj-yavl.api/infer-type-for-field","temp__5825__auto__","field-schema","clj-yavl.api/rename-column-values","col-name","mapping","escape-val","clojure.string/replace","expression","clojure.string.join","cljs.core.concat","cljs.core.map","p__25300","vec__25301","old","new","clj-yavl.api/transform-map","new-col","clj-yavl.api/transform-filter","predicate","clj-yavl.api/tooltip-def","keys","cljs.core/vec","iter__5503__auto__","s__25306","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__5501__auto__","size__5502__auto__","cljs.core/count","b__25308","cljs.core/chunk-buffer","i__25307","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__25305","cljs.core/chunk-rest","cljs.core/cons","cljs.core/rest","inferred-type","field-props","custom-format","field-def","cljs.core.assoc","p__25314","map__25315","cljs.core/--destructure-map","cljs.core.get","clj-yavl.api/wrap-with-facet","spec","row","column","facet","columns","or__5025__auto__","config","inner-spec","cljs.core.dissoc","facet-prop","base","cljs.core/map?","G__25316","G__25317","res","G__25318","p__25319","map__25320","clj-yavl.api/wrap-with-repeat","repeat","repeat-prop","and__5023__auto__","cljs.core/vector?","G__25321","G__25326","p__25328","map__25329","clj-yavl.api/add-transforms","transform","calculate","calc-transforms","existing","additional","all-transforms","var_args","args__5755__auto__","len__5749__auto__","i__5750__auto__","argseq__5756__auto__","cljs.core/IndexedSeq","clj-yavl.api/deep-merge","seq25331","self__5735__auto__","maps","cljs.core.apply","cljs.core/merge-with","x","y","clj_yavl.api.deep_merge","clj-yavl.api/base-plot","encodings","common-specs","charts-opts","data-schema","processed-encodings","cljs.core/reduce-kv","acc","channel","value","encoding-def","field","cljs.core/not","final-def","G__25332","final-specs","cljs.core.merge","clj-yavl.api/lift-config-from-specs","specs","configs","cljs.core.keep","merged-config","clean-specs","p1__25335#","cljs.core.mapv","clj-yavl.api/layer","vec__25337","children","G__25340","clj-yavl.api/hconcat","vec__25345","G__25348","clj-yavl.api/vconcat","vec__25349","G__25352","clj-yavl.api/concat-specs","vec__25353","G__25356","clj-yavl.api/spec","m","clj-yavl.api/facet","clj-yavl.api/repeat","cljs.core/chunk-first"],"sourcesContent":["(ns clj-yavl.api\n  (:require [malli.core :as m]\n            [clojure.string :as str])\n  (:refer-clojure :exclude [repeat]))\n\n;; Google Corporate Colors\n(def google-colors\n  [\"#4285F4\" \"#DB4437\" \"#F4B400\" \"#0F9D58\"])\n\n(def default-config\n  {:config {:range {:category google-colors} ;; [:scale :range] - Google corporate colors\n            :axis {:labelFontSize 12 :titleFontSize 14}\n            :header {:labelFontSize 12 :titleFontSize 14}\n            :legend {:labelFontSize 12 :titleFontSize 14}\n            :text {:fontSize 12}}\n   :width 400\n   :height 300})\n\n(defn- infer-vl-type\n  \"Infers the Vega-Lite type from a Malli schema node.\"\n  [schema-node]\n  (let [t (m/type schema-node)]\n    (cond\n      (#{'int? 'integer? 'number? 'double? 'float? :int :double :number :float} t) \"quantitative\"\n      (#{'string? :string} t) \"nominal\"\n      (#{'boolean? :boolean} t) \"nominal\"\n      (#{'inst? 'time? :inst :time} t) \"temporal\"\n      (= :enum t) \"nominal\"\n      :else nil)))\n\n(defn- get-field-schema\n  \"Finds the schema for a specific field within a dataset schema.\n   Handles schema being a Map or a Collection of Map.\"\n  [dataset-schema field-name]\n  (let [schema (m/schema dataset-schema)\n        t (m/type schema)\n        ;; Unwrap collection type if present to get to the item schema\n        map-schema (if (#{:vector :sequential :set :list} t)\n                     (first (m/children schema))\n                     schema)]\n    (when (= (m/type map-schema) :map)\n      (some (fn [[k _ v]]\n              (when (= (name k) field-name)\n                v))\n            (m/children map-schema)))))\n\n(defn- get-field-props\n  \"Finds the properties for a specific field within a dataset schema.\"\n  [dataset-schema field-name]\n  (let [schema (m/schema dataset-schema)\n        t (m/type schema)\n        ;; Unwrap collection type if present\n        map-schema (if (#{:vector :sequential :set :list} t)\n                     (first (m/children schema))\n                     schema)]\n    (when (= (m/type map-schema) :map)\n      (some (fn [[k props _]]\n              (when (= (name k) field-name)\n                props))\n            (m/children map-schema)))))\n\n(defn- infer-type-for-field\n  [dataset-schema field-name]\n  (when-let [field-schema (get-field-schema dataset-schema field-name)]\n    (infer-vl-type field-schema)))\n\n(defn rename-column-values\n  \"Creates a Vega-Lite calculate transform to rename values in a column.\n   Values not in the mapping are left unchanged.\n\n   Args:\n     col-name: The name of the column (string).\n     mapping: A map of {old-value new-value}.\n\n   Returns:\n     A map representing a Vega-Lite calculate transform.\"\n  [col-name mapping]\n  (let [escape-val (fn [v] (str/replace (str v) \"'\" \"\\\\'\"))\n        expression (str/join \" : \"\n                             (concat\n                              (map (fn [[old new]]\n                                     (str \"datum['\" col-name \"'] == '\" (escape-val old) \"' ? '\" (escape-val new) \"'\"))\n                                   mapping)\n                              [(str \"datum['\" col-name \"']\")]))]\n    {:calculate expression :as col-name}))\n\n(defn transform-map\n  \"Creates a Vega-Lite calculate transform (map operation).\n\n   Args:\n     new-col: The name of the new column (string).\n     expression: The Vega expression string.\n\n   Returns:\n     A map representing a Vega-Lite calculate transform.\"\n  [new-col expression]\n  {:calculate expression :as new-col})\n\n(defn transform-filter\n  \"Creates a Vega-Lite filter transform.\n\n   Args:\n     predicate: The Vega expression string for filtering.\n\n   Returns:\n     A map representing a Vega-Lite filter transform.\"\n  [predicate]\n  {:filter predicate})\n\n(defn tooltip-def\n  \"Generates a tooltip definition (vector of field definitions) for Vega-Lite.\n\n   Args:\n     keys: A sequence of field names (strings).\n     dataset-schema: The Malli schema of the dataset.\n\n   Returns:\n     A vector of maps, where each map matches StringFieldDef.\"\n  [keys dataset-schema]\n  (vec\n   (for [k keys]\n     (let [inferred-type (infer-type-for-field dataset-schema k)\n           field-props (get-field-props dataset-schema k)\n           custom-format (:format field-props)\n           field-def {:field k\n                      :type inferred-type}]\n       (cond\n         custom-format (assoc field-def :format custom-format)\n         (= inferred-type \"quantitative\") (assoc field-def :format \"s\")\n         :else field-def)))))\n\n(defn wrap-with-facet\n  \"Wraps a Vega-Lite spec with a facet operator.\n   Lifts :config to the top level.\n\n   opts keys: :row, :column, :facet, :columns\"\n  [spec {:keys [row column facet columns]}]\n  (if (or row column facet)\n    (let [config (:config spec)\n          ;; We keep width/height in the child spec (cell size)\n          inner-spec (dissoc spec :config)\n          facet-prop (if facet\n                       (let [base (if (map? facet) facet {:field facet})]\n                         (cond-> base\n                           columns (assoc :columns columns)))\n                       ;; else row/column\n                       (cond-> {}\n                         row (assoc :row (if (map? row) row {:field row}))\n                         column (assoc :column (if (map? column) column {:field column}))))\n          res {:facet facet-prop\n               :spec inner-spec}]\n      (cond-> res\n        config (assoc :config config)))\n    spec))\n\n(defn wrap-with-repeat\n  \"Wraps a Vega-Lite spec with a repeat operator.\n   Lifts :config to the top level.\n\n   opts keys: :repeat, :columns (if repeat is array)\"\n  [spec {:keys [repeat columns]}]\n  (if repeat\n    (let [config (:config spec)\n          inner-spec (dissoc spec :config)\n          repeat-prop (cond\n                        (and (map? repeat) (or (:row repeat) (:column repeat))) repeat\n                        (vector? repeat) repeat\n                        (string? repeat) [repeat]\n                        :else repeat)\n          res (cond-> {:repeat repeat-prop\n                       :spec inner-spec}\n                (and (vector? repeat-prop) columns) (assoc :columns columns))]\n      (cond-> res\n        config (assoc :config config)))\n    spec))\n\n(defn add-transforms\n  \"Adds transform operations to a Vega-Lite spec.\n\n   opts keys: :transform (vector of maps), :calculate (map or vector of maps)\"\n  [spec {:keys [transform calculate]}]\n  (let [calc-transforms (when calculate\n                          (if (vector? calculate)\n                            calculate\n                            [calculate]))\n        existing (or (:transform spec) [])\n        additional (concat (or transform []) (or calc-transforms []))\n        all-transforms (vec (concat existing additional))]\n    (if (seq all-transforms)\n      (assoc spec :transform all-transforms)\n      spec)))\n\n(defn- deep-merge\n  \"Recursively merges maps.\"\n  [& maps]\n  (apply merge-with (fn [x y]\n                      (if (and (map? x) (map? y))\n                        (deep-merge x y)\n                        y))\n         maps))\n\n(defn base-plot\n  \"Generates a Vega-Lite spec.\n\n   Args:\n   - encodings: map of channel (keyword) to encoding definition (map) or field name (string).\n   - common-specs: TopLevelSpec (map) defining global values (mark, data, etc.).\n   - charts-opts: map with optional keys:\n     - :data-schema -> Malli schema of the dataset.\"\n  [encodings common-specs charts-opts]\n  (let [data-schema (:data-schema charts-opts)\n        processed-encodings\n        (reduce-kv\n         (fn [acc channel value]\n           (let [encoding-def (if (string? value)\n                                {:field value}\n                                value)\n                 field (:field encoding-def)\n                 ;; Infer type if field is present and type is missing\n                 inferred-type (when (and data-schema field (not (:type encoding-def)))\n                                 (infer-type-for-field data-schema field))\n                 final-def (cond-> encoding-def\n                             inferred-type (assoc :type inferred-type))]\n             (assoc acc channel final-def)))\n         {}\n         encodings)\n        ;; Merge defaults into common-specs\n        final-specs (deep-merge default-config common-specs)]\n    (merge final-specs\n           (when (seq processed-encodings)\n             {:encoding processed-encodings}))))\n\n(defn- lift-config-from-specs\n  \"Helper to lift and merge :config from a list of specs.\n   Returns [merged-config specs-without-config].\"\n  [specs]\n  (let [configs (keep :config specs)\n        merged-config (when (seq configs) (apply deep-merge configs))\n        clean-specs (mapv #(dissoc % :config) specs)]\n    [merged-config clean-specs]))\n\n(defn layer\n  \"Creates a Layered View (LayerSpec) from a sequence of specs.\n   Lifts and merges :config from children to the top level.\"\n  [specs]\n  (let [[config children] (lift-config-from-specs specs)]\n    (cond-> {:layer children}\n      config (assoc :config config))))\n\n(defn hconcat\n  \"Creates a Horizontally Concatenated View (HConcatSpec).\n   Lifts and merges :config from children to the top level.\"\n  [specs]\n  (let [[config children] (lift-config-from-specs specs)]\n    (cond-> {:hconcat children}\n      config (assoc :config config))))\n\n(defn vconcat\n  \"Creates a Vertically Concatenated View (VConcatSpec).\n   Lifts and merges :config from children to the top level.\"\n  [specs]\n  (let [[config children] (lift-config-from-specs specs)]\n    (cond-> {:vconcat children}\n      config (assoc :config config))))\n\n(defn concat-specs\n  \"Creates a General Concatenated View (ConcatSpec).\n   Lifts and merges :config from children to the top level.\"\n  [specs]\n  (let [[config children] (lift-config-from-specs specs)]\n    (cond-> {:concat children}\n      config (assoc :config config))))\n\n(defn spec\n  \"Returns the provided map as a Vega-Lite specification.\n   Useful for explicit clarity or future validation.\"\n  [m]\n  m)\n\n;; Aliases for consistency and ease of use\n(def facet wrap-with-facet)\n(def repeat wrap-with-repeat)\n"]}