{"version":3,"sources":["clj_yavl/events.cljc"],"mappings":"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","names":["clj-yavl.events/default-config-json","clj-yavl.events/initialize-db","db","_","cljs.core/deref","user-input-exists?","cljs.core.get_in","component-state-exists?","unit-specs-exists?","ds-conn","clj_yavl.db.init_db","default-config","clj_yavl.io.read_json_str","cljs.core/keyword","clj-yavl.db/transact","clj-yavl.db/config->tx-data","ds-db","G__31252","cljs.core/not","cljs.core/assoc-in","cljs.core.assoc","p__31259","vec__31260","cljs.core.nth","clj-yavl.events/init-unit-spec","id","type","initial-input","or__5025__auto__","p__31263","vec__31264","clj-yavl.events/remove-unit-spec","cljs.core.update_in","cljs.core/dissoc","p__31272","vec__31277","clj-yavl.events/update-unit-spec-input","field","value","p__31280","vec__31281","clj-yavl.events/set-unit-spec-input","input","p__31284","vec__31285","clj-yavl.events/set-config-input","val","mode","parsed","e31288","cljs.core._EQ_","clojure.edn.read_string","G__31289","old-db","conn","p__31290","vec__31291","clj-yavl.events/set-config-mode","new-mode","user-input","current-mode","current-input","new-input","e31294","obj","edn-data","sb__5670__auto__","goog.string/StringBuffer","*print-newline*-orig-val__31295","cljs.core/*print-newline*","*print-fn*-orig-val__31296","cljs.core/*print-fn*","*print-newline*-temp-val__31297","*print-fn*-temp-val__31298","x__5671__auto__","cljs.pprint.pprint","e31299","clj_yavl.io.write_json_str","p__31302","vec__31303","clj-yavl.events/set-top-level-prop","prop-key","e31306","updated","*print-newline*-orig-val__31307","*print-fn*-orig-val__31308","*print-newline*-temp-val__31309","*print-fn*-temp-val__31310","clj-yavl.events/sync-config-from-db","config","clj-yavl.db/pull-config","*print-newline*-orig-val__31311","*print-fn*-orig-val__31312","*print-newline*-temp-val__31313","*print-fn*-temp-val__31314","p__31315","vec__31316","clj-yavl.events/update-mark","mark-type","mark-eid","cljs.core/ffirst","clj-yavl.db/q","tx-data","new-mark-id","new-ds-db","clj-yavl.db/with","re_frame.core.reg_event_db","p__31326","vec__31327","re_frame.core.reg_event_fx","p__31331","p__31332","map__31333","cljs.core/--destructure-map","cljs.core.get","vec__31334","url","p__31341","vec__31346","data","e31349","*print-newline*-orig-val__31350","*print-fn*-orig-val__31351","*print-newline*-temp-val__31352","*print-fn*-temp-val__31353","p__31354","vec__31355","err","js/console.error","re-frame.core/reg-fx","p__31358","map__31359","on-success","on-failure","js/fetch","resp","js/Promise.reject","json","re-frame.core/dispatch","cljs.core.conj","cljs.core.js__GT_clj","p__31365","vec__31366","clj-yavl.events/update-channel-field","channel","channel-eid","clj_yavl.db.q","cljs.core/name","enc-eid","new-chan-id","new-enc-id","p__31369","vec__31370","clj-yavl.events/update-tooltip","tooltip-def"],"sourcesContent":["(ns clj-yavl.events\n  (:require [clj-yavl.presets :as presets]\n            [clojure.edn :as edn]\n            [clj-yavl.io :as io]\n            [clojure.pprint :refer [pprint]]\n            [re-frame.core :as rf]\n            [clj-yavl.core :as-alias core]\n            [clj-yavl.db :as db]))\n\n(def default-config-json \"{\\n  \\\"$schema\\\": \\\"https://vega.github.io/schema/vega-lite/v5.json\\\",\\n  \\\"mark\\\": \\\"bar\\\",\\n  \\\"encoding\\\": {\\n    \\\"x\\\": {\\\"field\\\": \\\"col1\\\", \\\"type\\\": \\\"ordinal\\\"},\\n    \\\"y\\\": {\\\"field\\\": \\\"col2\\\", \\\"type\\\": \\\"quantitative\\\"}\\n  }\\n}\")\n\n(defn initialize-db\n  [db _]\n  (let [user-input-exists? (get-in db [:user-input :vega-lite])\n        component-state-exists? (::core/vega-lite db)\n        unit-specs-exists? (get-in db [:user-input :unit-specs])\n\n        ;; Initialize DataScript\n        ds-conn (db/init-db)\n        ;; Load default config into DS\n        default-config (io/read-json-str default-config-json {:key-fn keyword})\n        _ (db/transact ds-conn (db/config->tx-data \"default\" default-config))\n        ds-db @ds-conn]\n\n    (cond-> db\n      (not user-input-exists?)\n      (assoc-in [:user-input :vega-lite]\n                {:saved-configs {}\n                 :default {::core/data-input \"\"\n                           ::core/config-input default-config-json\n                           ::core/config-mode :json\n                           ::core/active-config-name nil\n                           ::core/ds-db ds-db}}) ;; Store DB value\n\n      (not component-state-exists?)\n      (assoc ::core/vega-lite\n             {::core/format :csv\n              ::core/structure :columnar\n              ::core/parsed-data nil\n              ::core/inferred-schema nil\n              ::core/active-left-tab :config})\n\n      (not unit-specs-exists?)\n      (assoc-in [:user-input :unit-specs] {}))))\n\n(defn init-unit-spec\n  [db [_ id type initial-input]]\n  (assoc-in db [:user-input :unit-specs id]\n            {:type type\n             :input (or initial-input {})}))\n\n(defn remove-unit-spec\n  [db [_ id]]\n  (update-in db [:user-input :unit-specs] dissoc id))\n\n(defn update-unit-spec-input\n  [db [_ id field value]]\n  (assoc-in db [:user-input :unit-specs id :input field] value))\n\n(defn set-unit-spec-input\n  [db [_ id input]]\n  (assoc-in db [:user-input :unit-specs id :input] input))\n\n(defn set-config-input\n  [db [_ val]]\n  ;; When text changes, update DS\n  ;; Note: This is a heavy operation for every keystroke.\n  ;; Ideally we debounce or only do it on blur/valid JSON.\n  ;; For now, we attempt to parse and if valid, update DS.\n  (let [mode (get-in db [:user-input :vega-lite :default ::core/config-mode])\n        parsed (try\n                 (if (= mode :json)\n                   (io/read-json-str val {:key-fn keyword})\n                   (edn/read-string val))\n                 (catch #?(:clj Exception :cljs :default) _ nil))]\n    (cond-> (assoc-in db [:user-input :vega-lite :default ::core/config-input] val)\n      parsed\n      (update-in [:user-input :vega-lite :default ::core/ds-db]\n                 (fn [old-db]\n                   ;; We need to re-create or update.\n                   ;; Since we don't have a smart diff yet, let's create a new DB for simplicity\n                   ;; or retract everything for \"default\" and re-insert.\n                   ;; Retracting recursively is hard without helper.\n                   ;; Let's just create a new DB for now to ensure consistency.\n                   (let [conn (db/init-db)]\n                     (db/transact conn (db/config->tx-data \"default\" parsed))\n                     @conn))))))\n\n(defn set-config-mode\n  [db [_ new-mode]]\n  (let [user-input (get-in db [:user-input :vega-lite :default])\n        current-mode (::core/config-mode user-input)\n        current-input (::core/config-input user-input)\n        new-input (cond\n                    (and (= current-mode :json) (= new-mode :edn))\n                    (try\n                      (let [obj (io/read-json-str current-input {:key-fn keyword})\n                            edn-data obj]\n                        (with-out-str (pprint edn-data)))\n                      (catch #?(:clj Exception :cljs :default) _ current-input))\n\n                    (and (= current-mode :edn) (= new-mode :json))\n                    (try\n                      (let [edn-data (edn/read-string current-input)]\n                        (io/write-json-str edn-data {:indent 2}))\n                      (catch #?(:clj Exception :cljs :default) _ current-input))\n\n                    :else current-input)]\n    (-> db\n        (assoc-in [:user-input :vega-lite :default ::core/config-mode] new-mode)\n        (assoc-in [:user-input :vega-lite :default ::core/config-input] new-input))))\n\n(defn set-top-level-prop\n  [db [_ prop-key value]]\n  ;; When setting a prop via UI (old way), we should probably use the new DS way.\n  ;; But to maintain backward compatibility or migrate, let's keep this but also update DS.\n  (let [user-input (get-in db [:user-input :vega-lite :default])\n        mode (::core/config-mode user-input)\n        input (::core/config-input user-input)]\n    (try\n      (let [parsed (if (= mode :json)\n                     (io/read-json-str input {:key-fn keyword})\n                     (edn/read-string input))\n            updated (assoc parsed prop-key value)\n            new-input (if (= mode :json)\n                        (io/write-json-str updated {:indent 2})\n                        (with-out-str (pprint updated)))]\n        (-> db\n            (assoc-in [:user-input :vega-lite :default ::core/config-input] new-input)\n            (update-in [:user-input :vega-lite :default ::core/ds-db]\n                       (fn [_]\n                         (let [conn (db/init-db)]\n                           (db/transact conn (db/config->tx-data \"default\" updated))\n                           @conn)))))\n      (catch #?(:clj Exception :cljs :default) _ db))))\n\n;; New Events for Granular Editing via DataScript\n\n(defn- sync-config-from-db\n  \"Helper to update text config from DS.\"\n  [db]\n  (let [ds-db (get-in db [:user-input :vega-lite :default ::core/ds-db])\n        config (db/pull-config ds-db \"default\")\n        mode (get-in db [:user-input :vega-lite :default ::core/config-mode])\n        new-input (if (= mode :json)\n                    (io/write-json-str config {:indent 2})\n                    (with-out-str (pprint config)))]\n    (assoc-in db [:user-input :vega-lite :default ::core/config-input] new-input)))\n\n(defn update-mark\n  [db [_ mark-type]]\n  ;; We need to transact into the DS DB stored in app-db.\n  ;; Since app-db stores the value, we need to 'edit' it.\n  ;; d/with works on db values.\n  (let [ds-db (get-in db [:user-input :vega-lite :default ::core/ds-db])\n        ;; We need to know the entity ID for the mark or create it.\n        ;; Since we don't have easy entity lookup here without query, let's use a standard query or assumption.\n        ;; Or better, re-transact the mark part using the same \"default\" id logic.\n        ;; But config->tx-data regenerates everything.\n\n        ;; Let's try to query for the mark entity.\n        mark-eid (ffirst (db/q '[:find ?e :where [?root :vl/mark ?e] [?root :vl/id \"default\"]] ds-db))\n\n        tx-data (if mark-eid\n                  [{:db/id mark-eid :mark/type mark-type}]\n                  (let [new-mark-id -1]\n                    [{:db/id [:vl/id \"default\"] :vl/mark new-mark-id}\n                     {:db/id new-mark-id :mark/type mark-type}]))\n\n        new-ds-db (db/with ds-db tx-data)]\n\n    (-> db\n        (assoc-in [:user-input :vega-lite :default ::core/ds-db] new-ds-db)\n        (sync-config-from-db))))\n\n(rf/reg-event-db\n ::set-dataset-url-input\n (fn [db [_ val]]\n   (assoc-in db [:user-input :dataset-url-input] val)))\n\n(rf/reg-event-fx\n ::fetch-dataset\n (fn [{:keys [db]} [_ url]]\n   {:promise/fetch {:url url\n                    :on-success [::fetch-dataset-success]\n                    :on-failure [::fetch-dataset-failure]}}))\n\n(rf/reg-event-db\n ::fetch-dataset-success\n (fn [db [_ data]]\n   (let [user-input (get-in db [:user-input :vega-lite :default])\n         mode (::core/config-mode user-input)\n         input (::core/config-input user-input)\n         parsed (try\n                  (if (= mode :json)\n                    (io/read-json-str input {:key-fn keyword})\n                    (edn/read-string input))\n                  (catch #?(:clj Exception :cljs :default) _ nil))\n\n         updated (when parsed (assoc parsed :data {:values data}))\n\n         new-input (when updated\n                     (if (= mode :json)\n                       (io/write-json-str updated {:indent 2})\n                       (with-out-str (pprint updated))))]\n     (if new-input\n       (-> db\n           (assoc-in [:user-input :vega-lite :default ::core/config-input] new-input)\n           (update-in [:user-input :vega-lite :default ::core/ds-db]\n                      (fn [_]\n                        (let [conn (db/init-db)]\n                          (db/transact conn (db/config->tx-data \"default\" updated))\n                          @conn))))\n       db))))\n\n(rf/reg-event-db\n ::fetch-dataset-failure\n (fn [db [_ err]]\n   (js/console.error \"Failed to fetch dataset:\" err)\n   db))\n\n;; Custom Effect for Fetching\n(rf/reg-fx\n :promise/fetch\n (fn [{:keys [url on-success on-failure]}]\n   (-> (js/fetch url)\n       (.then (fn [resp]\n                (if (.-ok resp)\n                  (.json resp)\n                  (js/Promise.reject (str \"Error: \" (.-statusText resp))))))\n       (.then (fn [json]\n                (rf/dispatch (conj on-success (js->clj json :keywordize-keys true)))))\n       (.catch (fn [err]\n                 (rf/dispatch (conj on-failure err)))))))\n\n(defn update-channel-field\n  [db [_ channel field]]\n  (let [ds-db (get-in db [:user-input :vega-lite :default ::core/ds-db])\n        ;; Find channel entity\n        channel-eid (ffirst (db/q '[:find ?c\n                                    :in $ ?channel-name\n                                    :where\n                                    [?root :vl/encoding ?enc]\n                                    [?root :vl/id \"default\"]\n                                    [?enc :encoding/channels ?c]\n                                    [?c :channel/name ?channel-name]]\n                                  ds-db (name channel)))\n\n        tx-data (if channel-eid\n                  [{:db/id channel-eid :channel/field field}]\n                  ;; If channel doesn't exist, we must create it and link to encoding\n                  (let [enc-eid (ffirst (db/q '[:find ?e :where [?root :vl/encoding ?e] [?root :vl/id \"default\"]] ds-db))\n                        new-chan-id -1]\n                     (if enc-eid\n                       [{:db/id enc-eid :encoding/channels new-chan-id}\n                        {:db/id new-chan-id :channel/name (name channel) :channel/field field}]\n                       ;; If encoding doesn't exist either\n                       (let [new-enc-id -2]\n                         [{:db/id [:vl/id \"default\"] :vl/encoding new-enc-id}\n                          {:db/id new-enc-id :encoding/channels new-chan-id}\n                          {:db/id new-chan-id :channel/name (name channel) :channel/field field}]))))\n\n        new-ds-db (db/with ds-db tx-data)]\n    (-> db\n        (assoc-in [:user-input :vega-lite :default ::core/ds-db] new-ds-db)\n        (sync-config-from-db))))\n\n(defn update-tooltip\n  [db [_ tooltip-def]]\n  (let [ds-db (get-in db [:user-input :vega-lite :default ::core/ds-db])\n        tx-data [{:db/id [:vl/id \"default\"] :vl/tooltip tooltip-def}]\n        new-ds-db (db/with ds-db tx-data)]\n    (-> db\n        (assoc-in [:user-input :vega-lite :default ::core/ds-db] new-ds-db)\n        (sync-config-from-db))))\n"]}